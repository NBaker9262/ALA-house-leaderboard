<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Control - House Points</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
<style>
body{font-family:Inter,Arial,sans-serif;margin:0;background:#f6f6f6;color:#111;padding:28px;}
.wrap{max-width:980px;margin:0 auto;display:none;}
.houses{display:flex;gap:12px;margin:16px 0;flex-wrap:wrap;}
.card{flex:1 1 45%;background:#fff;border-radius:10px;padding:12px}
.points{font-size:28px;font-weight:700}
button{padding:8px 12px;border-radius:8px;border:0;cursor:pointer}
.small{background:#eee}
.add{background:#2d9cdb;color:#fff}
.danger{background:#e74c3c;color:#fff}
.login{display:flex;flex-direction:column;align-items:center;justify-content:center;height:100vh;gap:10px;}
.login input{padding:10px;width:200px;}
</style>
</head>
<body>

<div class="login" id="loginBox">
  <input id="email" placeholder="Email">
  <input id="password" type="password" placeholder="Password">
  <button id="emailPassBtn">Sign In</button>
  <div id="loginMsg"></div>
</div>

<div class="wrap" id="mainPanel">
  <h2>House Points Control</h2>
  <div class="houses" id="houses"></div>
  <button id="undoBtn" class="small">Undo Last</button>
  <button id="resetBtn" class="danger">Reset All</button>
  <button id="signOutBtn" class="small">Sign Out</button>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import {
  getFirestore, doc, collection, runTransaction,
  onSnapshot, serverTimestamp, setDoc, getDoc
} from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";
import {
  getAuth, signInWithEmailAndPassword,
  onAuthStateChanged, signOut
} from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";

const firebaseConfig = {
  apiKey: "AIzaSyAAAz2beBA1QnvLPTbaq5LmEnR6m-VvK0s",
  authDomain: "ala-house-leaderboard.firebaseapp.com",
  projectId: "ala-house-leaderboard",
  storageBucket: "ala-house-leaderboard.firebasestorage.app",
  messagingSenderId: "827317744881",
  appId: "1:827317744881:web:c8518ba6523610ab006550"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);

const scoresDoc = doc(db,"leaderboard","scores");
const historyCol = collection(db,"leaderboard","scores","history");

const houses = ["red","white","blue","silver"];
const container = document.getElementById("houses");

houses.forEach(h=>{
  const d=document.createElement("div");
  d.className="card";
  d.innerHTML=`<b>${h}</b><div id="pts-${h}" class="points">0</div>
  <button class="small" onclick="change('${h}',10)">+10</button>
  <button class="small" onclick="change('${h}',-10)">-10</button>`;
  container.appendChild(d);
});

window.change = async (house,delta)=>{
  await runTransaction(db, async (t)=>{
    const snap = await t.get(scoresDoc);
    if(!snap.exists()) throw "Missing scores";

    const cur = snap.data()[house] || 0;

    t.update(scoresDoc,{
      [house]: cur + delta,
      lastAction:{house,delta,timestamp:serverTimestamp()},
      _confetti:{house}
    });

    t.set(doc(historyCol),{
      house,
      delta,
      timestamp:serverTimestamp(),
      adminUid: auth.currentUser.uid
    });
  });
};

document.getElementById("undoBtn").onclick = async ()=>{
  await runTransaction(db, async (t)=>{
    const snap = await t.get(scoresDoc);
    const la = snap.data().lastAction;
    if(!la) throw "Nothing to undo";

    t.update(scoresDoc,{
      [la.house]: (snap.data()[la.house]||0)-la.delta,
      lastAction:null
    });

    t.set(doc(historyCol),{
      house: la.house,
      delta: -la.delta,
      timestamp: serverTimestamp(),
      adminUid: auth.currentUser.uid
    });
  });
};

document.getElementById("resetBtn").onclick = async ()=>{
  await setDoc(scoresDoc,{red:0,white:0,blue:0,silver:0,lastAction:null,_confetti:null});
};

document.getElementById("signOutBtn").onclick=()=>signOut(auth);

onSnapshot(scoresDoc,s=>{
  if(!s.exists()) return;
  houses.forEach(h=>document.getElementById("pts-"+h).textContent=s.data()[h]||0);
});

onAuthStateChanged(auth, async u=>{
  if(!u){loginBox.style.display="flex";mainPanel.style.display="none";return;}
  const t = await u.getIdTokenResult();
  if(!t.claims.admin){await signOut(auth);return;}
  loginBox.style.display="none";mainPanel.style.display="block";
});

emailPassBtn.onclick=()=>signInWithEmailAndPassword(auth,email.value,password.value);
</script>
</body>
</html>
